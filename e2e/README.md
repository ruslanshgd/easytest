# E2E-тесты по чек-листу QA

Тесты автоматически запускают **figma-analytics** (порт 5174) и **figma-viewer** (порт 5173), затем проверяют сценарии из [.github/QA_TESTING_CHECKLIST.md](../.github/QA_TESTING_CHECKLIST.md).

## Запуск

Из корня репозитория:

```bash
cd e2e
npm install
npx playwright install
npm run test
```

Или из корня (если добавить скрипт в корневой `package.json`):

```bash
cd e2e && npm install && npx playwright install && npm run test
```

## Соответствие чек-листу

| Файл | Раздел чек-листа | Что проверяется |
|------|------------------|-----------------|
| `01-auth.spec.ts` | 1. Авторизация и вход | Форма входа; 1.3 выход (Профиль → Выйти) |
| `02-create-study.spec.ts` | 2. Создание и управление тестами | Редирект без входа; кнопка «Тест», форма создания; шаблоны 2.2–2.6 |
| `03-folders.spec.ts` | 3. Работа с папками | 3.1 создание папки; 3.3 переименование; 3.5 удаление |
| `04-blocks.spec.ts` | 4. Создание блоков | 4.2 Открытый вопрос; 4.4 Шкала; 4.5 Контекст; 4.13 UMUX-Lite |
| `05-edit-blocks.spec.ts` | 5. Настройки блоков | Открытие блока; 5.6 валидация обязательных полей |
| `06-study-mgmt.spec.ts` | 6. Управление тестами | 6.2 дубликация (Копировать); 6.5 удаление теста |
| `07-share.spec.ts` | 7. Публикация и шаринг | Вкладка «Поделиться», 7.1 Опубликовать, 7.3 Копировать ссылку |
| `08-viewer.spec.ts` | 8. Прохождение теста респондентом | `/finished`; `/run/{token}`; 8.2 Контекст, 8.4 Открытый вопрос (при `E2E_RUN_TOKEN`) |

## Тесты с авторизацией

Часть тестов (создание теста, вкладка «Поделиться») требует входа. Без авторизации они помечаются как **skip** с сообщением «Требуется авторизация».

Чтобы прогнать их с авторизацией:

1. Один раз войдите в приложение вручную в браузере (email + код из письма).
2. Сохраните состояние сессии: в консоли браузера или через [документацию Playwright](https://playwright.dev/docs/auth#reuse-signed-in-state) сохраните `storageState` в файл (например, `e2e/.auth/user.json`).
3. В `playwright.config.ts` добавьте проект с `storageState: 'e2e/.auth/user.json'` и запускайте тесты с этим проектом.

Либо оставьте тесты как есть: они проверяют сценарии без входа (редирект на форму входа) и при наличии входа (кнопки и вкладки).

**Viewer (раздел 8):** тесты 8.2 и 8.4 (прохождение блока «Контекст» и «Открытый вопрос») выполняются только при заданной переменной окружения `E2E_RUN_TOKEN` — токен опубликованного теста. Получить токен: в analytics опубликовать тест, на вкладке «Поделиться» нажать «Копировать ссылку», из URL взять часть после `/run/`. Запуск: `E2E_RUN_TOKEN=... npm run test`.

## Почему тесты пропущены (skipped)

При запуске без авторизации большинство тестов пропускаются (`-` в выводе) по следующим причинам:

### Основная причина: требуется авторизация

**25 из 35 тестов** требуют входа в систему. Они пропускаются с сообщением `"Требуется авторизация"`:

- **Раздел 1** (1.3): выход из системы
- **Раздел 2** (2.1–2.6): создание теста, шаблоны
- **Раздел 3** (3.1, 3.3, 3.5): работа с папками
- **Раздел 4** (4.2, 4.4, 4.5, 4.13): добавление блоков
- **Раздел 5** (5.2, 5.6): редактирование блоков
- **Раздел 6** (6.2, 6.5): управление тестами
- **Раздел 7** (7.1, 7.3): публикация и шаринг

**Решение:** см. раздел "Тесты с авторизацией" выше.

### Другие причины пропуска:

1. **Нет данных для теста:**
   - `"Нет тестов для копирования"` — нужен хотя бы один тест
   - `"Нет пустого состояния с шаблонами"` — шаблоны видны только когда нет тестов
   - `"Нет папок для удаления"` — нужна хотя бы одна папка
   - `"Нет блоков для редактирования"` — нужен тест с блоками

2. **Состояние уже изменено:**
   - `"Тест уже опубликован или остановлен"` — для теста публикации нужен черновик
   - `"Нужно минимум 2 теста"` — для удаления нужен запас

3. **Нет токена для viewer:**
   - `"Задайте E2E_RUN_TOKEN"` — для 8.2 и 8.4 нужен токен опубликованного теста

### Что проверяется без авторизации:

**10 тестов проходят** и проверяют:
- Редирект на форму входа (все разделы)
- Страница завершения viewer (`/finished`)
- Обработка невалидного токена (`/run/{invalid}`)

## Детали реализации

Все причины пропуска тестов указаны в коде через `test.skip(true, "причина")`. Посмотреть можно в файлах:
- `e2e/tests/01-auth.spec.ts` — раздел 1
- `e2e/tests/02-create-study.spec.ts` — раздел 2
- `e2e/tests/03-folders.spec.ts` — раздел 3
- `e2e/tests/04-blocks.spec.ts` — раздел 4
- `e2e/tests/05-edit-blocks.spec.ts` — раздел 5
- `e2e/tests/06-study-mgmt.spec.ts` — раздел 6
- `e2e/tests/07-share.spec.ts` — раздел 7
- `e2e/tests/08-viewer.spec.ts` — раздел 8

## Полезные команды

- `npm run test` — все тесты
- `npm run test:analytics` — только тесты analytics (разделы 1, 2, 3, 7)
- `npm run test:viewer` — только тесты viewer (раздел 8)
- `npm run test:headed` — с видимым браузером
- `npm run test:ui` — интерактивный режим Playwright UI
