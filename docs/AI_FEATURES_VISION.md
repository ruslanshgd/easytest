# AI-функции: Синтетические пользователи и анализ данных

> Документ описывает концепцию, сценарии и техническую реализацию AI-функций в продукте FigmaTest.  
> **Статус:** Концепция, не реализовано.  
> **Обновлено:** 2025-01-31

---

## 1. Суть идеи

### 1.1 Проблема

Каждый тест с респондентами стоит денег (найм, стимулы, время). Дизайнеры и продуктовые команды хотят:
- проверять гипотезы до полномасштабного теста;
- избегать очевидных юзабилити-ошибок;
- быстрее получать инсайты из уже собранных данных.

### 1.2 Решение

Использовать накопленные данные (ответы, события, пути, время) для:
1. **Синтетических пользователей** — AI-персоны, сгенерированные из кластеров реальных респондентов, которые «проходят» прототипы и дают фидбэк.
2. **AI-анализа** — инсайты, топики, рекомендации по ответам (от десятков до сотен и тысяч).
3. **Улучшения формулировок** — кнопка «Улучшить» рядом с заданиями/вопросами блоков.
4. **Дополнительных AI-вопросов** (опционально) — уточняющие вопросы во время прохождения теста.

---

## 2. Область применения (Scope)

### 2.1 Текущий scope — без глобальной аналитики

Полноценная аналитика по **всем тестам во всех папках** — это будущее. Сейчас ограничиваемся:

| Контекст | Описание | Точка входа |
|----------|----------|-------------|
| **Один тест** | Анализ только внутри выбранного теста | Кнопка в StudyDetail / StudyResultsTab |
| **Несколько тестов** | Анализ выбранных тестов | Чекбоксы + кнопка «Проанализировать с помощью ИИ» в bulk-баре |
| **Папка** | Анализ всех тестов внутри папки | Троеточие на карточке папки → «Проанализировать с помощью ИИ» |

### 2.2 UI-точки входа (существующие паттерны)

#### 2.2.1 Один тест
- В `StudyDetail` (вкладка «Результаты» или отдельная вкладка «ИИ») — кнопка «Проанализировать с помощью ИИ».
- Контекст: текущий `studyId`.

#### 2.2.2 Несколько тестов (выбор чекбоксами)
- В `StudiesList` уже есть: `selectedStudies`, bulk-бар с «Переместить» и «Удалить».
- Добавить кнопку **«Проанализировать с помощью ИИ»** рядом с «Переместить».
- При клике: открыть модал/страницу анализа для `Array.from(selectedStudies)`.
- Требование: хотя бы один тест выбран.

#### 2.2.3 Папка
- У карточки папки уже есть `DropdownMenu` (троеточие): «Переименовать», «Переместить», «Удалить».
- Добавить пункт **«Проанализировать с помощью ИИ»**.
- При клике: загрузить все тесты и открыть модал/страницу анализа.

**Решено:** анализировать **включая тесты из всех вложенных папок** (рекурсивный обход дочерних папок).

### 2.3 Будущее (вне текущего scope)

- Отдельное пространство «Аналитика» — агрегация по всем тестам, папкам, команде.
- Пока не планируется.

---

## 3. Какие данные есть

### 3.1 Supabase-таблицы

| Таблица | Содержимое |
|---------|------------|
| `study_block_responses` | run_id, block_id, answer (JSONB), duration_ms, created_at |
| `sessions` | run_id, prototype_id, started_at, completed, aborted, recording_url, umux_lite_*, feedback_text |
| `events` | session_id, event_type, screen_id, hotspot_id, timestamp, x, y, scroll_* |
| `gaze_points` | eye tracking (опционально) |
| `prototypes` | Proto JSON (screens, hotspots, edges) |
| `study_blocks` | type, config, instructions |
| `study_runs` | study_id, share_id, started_at, finished_at, status, client_meta |

### 3.2 Типы блоков и форматы ответов

| Блок | Пример answer |
|------|---------------|
| open_question | `{ text: string }` |
| scale | `{ value: number }` |
| choice | `{ selected: string[], other?: string }` |
| preference | `{ selectedIndex, wins }` |
| matrix | `{ selections: { rowId: string[] } }` |
| agreement | `{ accepted: boolean, acceptedAt }` |
| card_sorting | `{ categories: {...}, unsortedCount }` |
| tree_testing | `{ pathNames, isCorrect, duration_ms }` |
| first_click | `{ x, y }` |
| prototype | `{ finalScreen, screenName }` + события в `events` |
| five_seconds | текстовые ответы |
| umux_lite | `{ umux_lite_score, sus_score, feedback }` |

### 3.3 Минимальные объёмы данных и рекомендации для UI

**Принцип:** больше данных → выше достоверность. Ниже — ориентиры для порогов и подсказок в интерфейсе.

| Функция | Мин. респондентов* | Рекомендуемо | Поведение в UI |
|---------|--------------------|--------------|----------------|
| **Кнопка «Улучшить»** | 0 | — | Всегда доступна (не требует ответов). |
| **AI-инсайты** (топики) | 10–15 | 30+ | При &lt;10 — предупреждение: «Мало данных, инсайты могут быть ненадёжными. Рекомендуем 30+ ответов.» Разрешить запуск. |
| **Синтетические пользователи** | 20–30 | 50+ | При &lt;20 — предупреждение: «Сегменты могут быть шумными. Рекомендуем 50+ респондентов.» Разрешить запуск. |
| **AI follow-up вопросы** | 0 | — | Не зависят от объёма данных (работают в реальном времени). |

\* *Респондент* = уникальный `run_id` (один проход теста). При выборе нескольких тестов или папки — сумма респондентов по всем выбранным тестам.

**Примеры:**
- 1 тест: 5 респондентов → инсайты возможны, но с предупреждением; синтетики — не рекомендуется.
- 2 теста: 10 + 15 = 25 респондентов → инсайты ок; синтетики — с предупреждением.
- 1 тест: 20 респондентов → инсайты и синтетики допустимы, желательно больше данных.
- 3 теста: 20 + 15 + 30 = 65 респондентов → оба сценария без ограничений.

**Рекомендуемый текст в модале анализа:**
- Если данных достаточно: «Достаточно данных для анализа.»
- Если мало: «Собрано N респондентов. Рекомендуем 30+ для инсайтов и 50+ для синтетических пользователей. Продолжить?»

---

## 4. Функции и сценарии

### 4.1 Синтетические пользователи

**Идея:** на основе данных реальных респондентов создать сегменты и сгенерировать AI-«пользователей», которые «кликают» по прототипу, проходят блоки и дают фидбэк.

**Вход:**
- Один или несколько тестов (study_ids).
- Proto (screens, hotspots, edges).
- Ответы, события, пути, время.

**Выход:**
- Синтетические «ответы»: путь по экранам, клики, открытые ответы, шкалы, выборы.
- Метаданные: доверительность (N респондентов в сегменте), пометка «AI-generated».

**Сегменты — Jobs to be Done, не персоны**

Сегменты не фиксированы (уверенные, новички и т.д.). Их может быть много. Генерировать через фреймворк **Jobs to be Done** через **job stories**:

> *Когда* [ситуация] *я хочу* [мотивация] *чтобы* [ожидаемый результат].

Для каждого сегмента фиксировать **«Поведение»** на основе данных предыдущих тестов:

| Тип данных | Что фиксируем |
|------------|---------------|
| Figma-прототип | Пути, клики, время на экране, переходы, успешность |
| Карточная сортировка | Распределение по категориям, количество unsorted |
| Тесты дерева | Пути, прямые/непрямые, время, успешность |
| Шкалы | Распределение значений |
| Матрицы | Паттерны выборов по строкам/столбцам |
| Выбор (choice) | Частота опций, «другое» |
| Открытые вопросы | Тематика ответов, тональность, длина |

Сегменты и их поведение извлекаются из агрегированных данных выбранных тестов.

### 4.2 AI-инсайты

**Идея:** автоматически находить паттерны в ответах (от десятков до тысяч), категоризировать по топикам.

**Вход:**
- Ответы из выбранных тестов (study_ids).
- Типы блоков, instructions.

**Выход:**
- Топики: технические баги, клиентский опыт, доверие, навигация и т.д.
- Для каждого: % ответов, количество, ссылка на фильтрацию по ответам.
- Пометка «AI-generated».

### 4.3 Кнопка «Улучшить» для заданий блоков

**Идея:** улучшить формулировку instructions/config с учётом best practices для типа блока.

**Вход:**
- Тип блока (open_question, choice, scale и т.д.).
- Текущий текст задания/вопроса.

**Выход:**
- Улучшенный текст (подставляется в поле, пользователь может редактировать).

**Пример:**
- Было: «Насколько вам понравилась эта фича?»
- Стало: «Не могли бы вы поделиться своим опытом при использовании продукта?»

### 4.4 Дополнительные AI-вопросы (опционально)

**Идея:** для блока open_question — AI задаёт уточняющие вопросы на основе ответа респондента. Каждый дополнительный вопрос — это **следующий блок типа open_question** в потоке теста.

**Настройки в конструкторе (figma-analytics):**
- Чекбокс «Дополнительные AI-вопросы».
- Слайдер «Максимальное количество дополнительных вопросов» (1–5).
- Textarea с инструкцией для AI (например: «если упомянуты конкретные инструменты — спроси, почему выбрали именно их, а не альтернативы; если используют много инструментов — уточни, без какого не смогли бы работать и почему»).

**Поток в figma-viewer** (иллюстративный пример; реальные вопросы генерируются динамически):

1. Респондент видит блок open_question: *«Какими инструментами вы пользуетесь для удалённой работы и созвонов с командой?»*
2. Пишет ответ, например: «В основном Контур-Толк».
3. Нажимает «Далее».
4. **Если чекбокс «Дополнительные AI-вопросы» включён** — появляется следующий блок open_question, но **вопрос сгенерирован ИИ** на основе ответа и инструкции из конструктора. Например: *«Почему вы выбрали именно Контур-Толк для удалённой работы, а не альтернативные мессенджеры или корпоративные чаты?»*
5. Респондент отвечает. Нажимает «Далее».
6. ИИ может задать ещё один уточняющий вопрос (до лимита из слайдера). Например: *«Без какого из используемых инструментов (Контур-Толк или встроенный мессенджер Тайм) вы точно не смогли бы работать и почему именно без него?»*
7. Когда ИИ закончил задавать вопросы (достигнут лимит или больше нечего уточнять) — открывается **следующий блок из конструктора** (тот, что был запланирован после исходного open_question).

**Реализация:** динамическая вставка блоков open_question в StudyRunView. Не отдельный диалог — обычный блок с вопросом, полем ответа и кнопкой «Далее». Вопрос генерируется через API (OpenAI) после каждого ответа. Блоки AI-вопросов сохраняются в `study_block_responses` как обычные ответы (можно помечать `block_id` или `config.is_ai_followup` для отчётов).

---

## 5. Техническая реализация

### 5.1 Стек

- **Frontend:** React, Zustand (figma-analytics).
- **Backend:** Supabase Edge Functions (или отдельный сервис).
- **AI:** OpenAI API (gpt-4o).
- **figma-viewer:** только при AI follow-up вопросах.
- **figma-plugin:** без изменений.

### 5.2 Архитектура

```
figma-analytics
├── Точки входа:
│   ├── StudyDetail → кнопка «Проанализировать с ИИ» (1 тест)
│   ├── StudiesList bulk-бар → «Проанализировать с ИИ» (N тестов)
│   └── StudiesList карточка папки → DropdownMenuItem «Проанализировать с ИИ»
├── Модал/страница AI Analysis
│   ├── Выбор функций (инсайты, синтетики, улучшить)
│   ├── Прогресс и результат
│   └── Отображение рекомендаций, инсайтов, синтетических ответов
└── Store: aiAnalysisStore (состояние, studyIds, результаты)

Supabase Edge Functions (или backend)
├── POST /api/ai/insights        — ответы → топики
├── POST /api/ai/synthetic-run   — Proto + персоны → синтетические ответы
└── POST /api/ai/improve-text    — блок + текст → улучшенный текст

OpenAI API (key на backend, не в frontend)
```

### 5.3 Получение study_ids по контексту

| Контекст | Как получить study_ids |
|----------|------------------------|
| 1 тест | `[studyId]` из StudyDetail |
| N тестов | `Array.from(selectedStudies)` из StudiesList |
| Папка | Рекурсивный обход: все тесты с `folder_id` в выбранной папке или любой вложенной |

### 5.4 Доверительность и прозрачность

- Для синтетических ответов: `trust_score`, `segment_size` (N респондентов).
- Явная пометка «Сгенерировано ИИ» в UI.
- Возможность фильтровать «только реальные» / «только синтетические».

---

## 6. Фазы реализации

| Фаза | Функция | Сложность | Scope |
|------|---------|-----------|-------|
| 1 | Кнопка «Улучшить» для instructions | Низкая | 1 тест (в блоке) |
| 2 | AI-инсайты (топики по ответам) | Средняя | 1 тест, N тестов, папка |
| 3 | Точки входа: bulk-бар, папка | Низкая | UI |
| 4 | Кластеризация респондентов | Средняя | 1 тест, N тестов |
| 5 | Синтетические пользователи + прогон | Высокая | 1 тест, N тестов |
| 6 | AI follow-up вопросы | Высокая | 1 тест (figma-viewer) |

---

## 7. Риски и ограничения

- **OpenAI API:** стоимость, лимиты. Self-hosted: пользователь вводит свой key.
- **Валидность синтетиков:** AI может усреднять, не воспроизводить крайности.
- **Промптинг:** Proto может быть большим — нужна компрессия структуры.
- **Конфиденциальность:** данные остаются у пользователя (self-hosted).

---

## 8. Будущее (вне scope)

- Отдельный раздел «Аналитика» — агрегация по всем тестам и папкам.
- Единое хранилище AI-инсайтов по всем исследованиям.
- Кросс-тестовые тренды и рекомендации.

---

## 9. Экономика: ориентировочная стоимость (OpenAI API)

Оценки на основе типовых цен OpenAI (GPT-4o-mini / GPT-5 mini: ~$0.25/1M input, ~$2/1M output). Фактическая стоимость зависит от модели, длины ответов и промптов. Цены в USD.

### 9.1 Кнопка «Улучшить»

| Сценарий | Стоимость |
|----------|-----------|
| 1 клик (любой объём данных) | ~$0.01 |
| 10 кликов подряд | ~$0.10 |
| 50 кликов в месяц | ~$0.50 |

*Не зависит от количества ответов в тесте — один запрос на улучшение.*

### 9.2 AI-инсайты (топики по ответам)

| Ответов в выборке | Ориентировочная стоимость |
|-------------------|---------------------------|
| 10 | ~$0.03–0.05 |
| 30 | ~$0.05–0.10 |
| 50 | ~$0.08–0.15 |
| 100 | ~$0.15–0.25 |
| 300 | ~$0.40–0.70 |
| 500 | ~$0.60–1.00 |
| 1 000+ | ~$1.00–2.50 |

*Один или несколько вызовов API. При большом объёме возможна предобработка/суммаризация.*

### 9.3 Синтетические пользователи

| Сценарий | Стоимость |
|----------|-----------|
| Генерация сегментов (20–50 респондентов) | ~$0.05–0.15 |
| 5 синтетиков × 1 прототип (10 экранов) + 5 блоков | ~$0.15–0.30 |
| 10 синтетиков × 1 прототип + 8 блоков | ~$0.30–0.60 |
| 10 синтетиков × 2 прототипа + 10 блоков | ~$0.60–1.20 |

*Слагаемые: генерация сегментов + прогон по прототипу (клики) + ответы по блокам (open_question, scale, choice и т.д.).*

### 9.4 AI follow-up вопросы (во время теста)

| Сценарий | Стоимость на 1 респондента |
|----------|----------------------------|
| 1 дополнительный вопрос | ~$0.01–0.02 |
| 3 дополнительных вопроса (макс. из слайдера) | ~$0.03–0.06 |
| 100 респондентов × 2 вопроса в среднем | ~$2–4 |

*Оплата по факту: только когда респондент проходит блок с включёнными AI-вопросами.*

### 9.5 Сводка по типичным сценариям

| Действие | Оценка |
|----------|--------|
| Анализ 1 теста (30 ответов): инсайты | ~$0.10 |
| Анализ 3 тестов (25+40+50 ответов): инсайты | ~$0.25 |
| 1 тест: инсайты + 5 синтетиков | ~$0.30–0.50 |
| Активное использование (10 «Улучшить» + 5 инсайтов + 2 запуска синтетиков в месяц) | ~$1–3/мес |

**Примечание:** self-hosted — пользователь платит за свой API key. Можно заложить лимиты и предупреждения в UI (например, «Ориентировочная стоимость этого запроса: ~$0.50»).
