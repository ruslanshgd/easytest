<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Export Prototype JSON</title>
  <style>
    /* Design Tokens */
    :root {
      --text-primary: rgba(25, 28, 48, 0.90);
      --text-secondary: rgba(27, 31, 59, 0.65);
      --icon: rgba(27, 31, 59, 0.40);
      --brand: #526ED3;
      --btn-secondary-bg: #F4F4F4;
      --input-border: #E0E0E0;
      --shadow-input: 0px 2px 3px rgba(0, 0, 0, 0.10);
    }

    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      color: var(--text-primary);
    }
    /* Primary Button (default for all buttons) */
    button {
      padding: 8px 12px;
      background: var(--brand);
      color: #FFFFFF;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
      margin-bottom: 8px;
      transition: background-color 150ms, opacity 150ms, box-shadow 150ms;
    }
    button:hover:not(:disabled) {
      background: var(--brand);
      opacity: 0.95;
    }
    button:disabled {
      background: var(--brand);
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
    }
    /* Primary button class for explicit primary actions */
    .btn-primary {
      background: var(--brand);
      color: #FFFFFF;
    }
    .btn-primary:hover:not(:disabled) {
      background: var(--brand);
      opacity: 0.95;
    }
    /* Secondary Button */
    .btn-secondary {
      background: var(--btn-secondary-bg);
      color: var(--brand);
      border: none;
    }
    .btn-secondary:hover {
      background: var(--btn-secondary-bg);
      opacity: 0.97;
    }

    .info {
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-primary);
    }
    .url-container {
      margin-top: 12px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 4px;
      display: none;
    }
    .url-container.show {
      display: block;
    }
    .url-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      margin-bottom: 8px;
      background: #FFFFFF;
      color: var(--text-primary);
      box-shadow: var(--shadow-input);
      transition: background-color 150ms, opacity 150ms, box-shadow 150ms;
    }
    .url-input:focus {
      outline: 2px solid rgba(82, 110, 211, 0.25);
      outline-offset: 1px;
      border-color: var(--input-border);
    }
    .url-copy-btn {
      background: var(--brand);
      color: #FFFFFF;
      font-size: 12px;
      padding: 6px 10px;
      margin-bottom: 0;
    }
    .url-copy-btn:hover {
      background: var(--brand);
      opacity: 0.95;
    }
    .status {
      margin-top: 8px;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      display: block;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      display: block;
    }
    .status.loading {
      background: #d1ecf1;
      color: #0c5460;
      display: block;
    }
    hr {
      border: none;
      border-top: 1px solid var(--input-border);
      margin: 16px 0;
    }
    .settings-form {
      display: block;
      padding: 0;
      background: transparent;
      border-radius: 0;
      margin-bottom: 0;
    }
    .settings-form label {
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .settings-form input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-size: 12px;
      font-family: monospace;
      box-sizing: border-box;
      margin-bottom: 12px;
      background: #FFFFFF;
      color: var(--text-primary);
      box-shadow: var(--shadow-input);
      transition: background-color 150ms, opacity 150ms, box-shadow 150ms;
    }
    .settings-form input:focus {
      outline: 2px solid rgba(82, 110, 211, 0.25);
      outline-offset: 1px;
      border-color: var(--input-border);
    }
    .settings-form input::placeholder {
      color: var(--text-secondary);
    }
    .settings-form .help-text {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: -8px;
      margin-bottom: 12px;
    }
    .settings-buttons {
      display: flex;
      gap: 8px;
    }
    .settings-buttons button {
      flex: 1;
      margin-bottom: 0;
    }
    .settings-btn {
      background: var(--btn-secondary-bg);
      color: var(--brand);
      font-size: 12px;
      padding: 6px 10px;
    }
    .settings-btn:hover {
      background: var(--btn-secondary-bg);
      opacity: 0.97;
    }
    .main-content {
      display: none;
    }
    .main-content.show {
      display: block;
    }
    .task-input-container {
      margin-bottom: 16px;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .task-input-container label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .task-input-container textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--input-border);
      border-radius: 4px;
      font-size: 12px;
      font-family: Arial, sans-serif;
      box-sizing: border-box;
      resize: vertical;
      min-height: 60px;
      margin-bottom: 4px;
      background: #FFFFFF;
      color: var(--text-primary);
      box-shadow: var(--shadow-input);
      transition: background-color 150ms, opacity 150ms, box-shadow 150ms;
    }
    .task-input-container textarea:focus {
      outline: 2px solid rgba(82, 110, 211, 0.25);
      outline-offset: 1px;
      border-color: var(--input-border);
    }
    .task-input-container textarea::placeholder {
      color: var(--text-secondary);
    }
    .task-input-container .help-text {
      font-size: 11px;
      color: var(--text-secondary);
    }
    .task-input-container .char-count {
      font-size: 11px;
      color: var(--text-secondary);
      text-align: right;
      margin-top: 4px;
    }
    .task-input-container .char-count.warning {
      color: #ff9800;
    }
    .task-input-container .char-count.error {
      color: #f44336;
    }
    .mode-btn.active {
      background: var(--brand) !important;
      color: #FFFFFF !important;
    }
    .mode-btn:not(.active) {
      background: var(--btn-secondary-bg) !important;
      color: var(--text-primary) !important;
    }

    /* Icon styles */
    .icon, [class*="icon"], button[class*="icon"] {
      color: var(--icon);
      transition: opacity 150ms;
    }
    .icon:hover, [class*="icon"]:hover, button[class*="icon"]:hover {
      opacity: 0.55;
    }
    .icon:active, [class*="icon"]:active, button[class*="icon"]:active {
      opacity: 0.65;
    }
    
    /* SVG Icon wrapper */
    .icon-svg {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }
    .icon-svg svg {
      width: 100%;
      height: 100%;
    }
    
    /* Icon button styles */
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 150ms, opacity 150ms;
    }
    .icon-btn:hover {
      background: rgba(27, 31, 59, 0.05);
    }
    .icon-btn:active {
      background: rgba(27, 31, 59, 0.1);
    }
    
    /* Help icon (hint) */
    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      cursor: help;
      vertical-align: middle;
    }
    
    /* Search button icon */
    .search-icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }

    /* Global input styles */
    input[type="text"],
    input[type="url"],
    textarea,
    select {
      border: 1px solid var(--input-border);
      border-radius: 4px;
      background: #FFFFFF;
      color: var(--text-primary);
      box-shadow: var(--shadow-input);
      transition: background-color 150ms, opacity 150ms, box-shadow 150ms;
    }
    input[type="text"]:focus,
    input[type="url"]:focus,
    textarea:focus,
    select:focus {
      outline: 2px solid rgba(82, 110, 211, 0.25);
      outline-offset: 1px;
      border-color: var(--input-border);
    }
    input[type="text"]::placeholder,
    input[type="url"]::placeholder,
    textarea::placeholder {
      color: var(--text-secondary);
    }
    
    /* Select dropdown arrow */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M3.29289 5.29289C3.68342 4.90237 4.31658 4.90237 4.70711 5.29289L8 8.58579L11.2929 5.29289C11.6834 4.90237 12.3166 4.90237 12.7071 5.29289C13.0976 5.68342 13.0976 6.31658 12.7071 6.70711L8.70711 10.7071C8.31658 11.0976 7.68342 11.0976 7.29289 10.7071L3.29289 6.70711C2.90237 6.31658 2.90237 5.68342 3.29289 5.29289Z' fill='%231B1F3B' fill-opacity='0.4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 32px;
    }

    /* Tabs styles */
    .tabs {
      display: flex;
      gap: 16px;
      border-bottom: 1px solid var(--input-border);
      margin-bottom: 16px;
      padding-bottom: 0;
    }
    .tab {
      padding: 8px 0;
      color: var(--text-secondary);
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: color 150ms, border-color 150ms;
    }
    .tab.active {
      color: var(--text-primary);
      border-bottom-color: var(--brand);
    }
    .tab:hover:not(.active) {
      color: var(--text-primary);
      opacity: 0.8;
    }
    
    /* Tab content */
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    /* Tooltip styles */
    .tooltip-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 4px;
      cursor: help;
      vertical-align: middle;
    }
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 8px;
      padding: 8px 12px;
      background: #FFFFFF;
      border-radius: 4px;
      box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.15);
      color: var(--text-primary);
      font-size: 11px;
      line-height: 1.4;
      white-space: normal;
      max-width: 200px;
      z-index: 1000;
      display: none;
      pointer-events: none;
    }
    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #FFFFFF;
    }
    .tooltip-wrapper:hover .tooltip {
      display: block;
    }
    
    
    /* Instructions list */
    .instructions {
      list-style: none;
      padding: 0;
      margin: 0 0 16px 0;
    }
    .instructions li {
      font-size: 12px;
      color: var(--text-primary);
      margin-bottom: 4px;
      padding-left: 0;
    }
  </style>
</head>
<body>
  <!-- Табы -->
  <div class="tabs">
    <button class="tab active" id="prototypeTab">Прототип</button>
    <button class="tab" id="settingsTab">Настройки</button>
  </div>
  
  <!-- Контент таба "Прототип" -->
  <div id="prototypeTabContent" class="tab-content active">
    <!-- Инструкции -->
    <ol class="instructions">
      <li>1. Нажмите "Share" в правом верхнем углу</li>
      <li>2. Скопируйте ссылку и вставьте ее в поле ниже</li>
    </ol>
    
    <!-- Поле для Share ссылки -->
    <div style="margin-bottom: 16px;">
      <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <label for="shareLink" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Вставьте ссылку и выберите сценарий</label>
        <div class="tooltip-wrapper">
          <span class="tooltip-icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
          </span>
          <div class="tooltip">Найдем все ваши сценарии, чтобы выбрать один из них</div>
        </div>
      </div>
      <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <input 
          type="text" 
          id="shareLink" 
          placeholder="Ссылка файла Figma" 
          style="flex: 1; padding: 8px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 12px; font-family: monospace; box-sizing: border-box; background: #FFFFFF; color: var(--text-primary); box-shadow: var(--shadow-input);"
        />
        <button id="importFromLink" class="search-icon-btn" style="width: 32px; height: 32px; padding: 0; border: none; border-radius: 4px; cursor: pointer; background: transparent; flex-shrink: 0;">
          <span class="icon-svg"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 1C10.3137 1 13 3.68629 13 7C13 8.2957 12.587 9.49385 11.8887 10.4746L14.707 13.293C15.0976 13.6835 15.0976 14.3165 14.707 14.707C14.3165 15.0976 13.6835 15.0976 13.293 14.707L10.4746 11.8887C9.49385 12.587 8.2957 13 7 13C3.68629 13 1 10.3137 1 7C1 3.68629 3.68629 1 7 1ZM7 3C4.79086 3 3 4.79086 3 7C3 9.20914 4.79086 11 7 11C9.20914 11 11 9.20914 11 7C11 4.79086 9.20914 3 7 3Z" fill="#526ED3"/></svg></span>
        </button>
      </div>
      
      <!-- Flows container -->
      <div id="flowsContainer" style="display: none; margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 6px; font-size: 12px; font-weight: 500; color: var(--text-primary);">Выберите один сценарий (flow)</label>
        <select id="flowsSelect" style="width: 100%; padding: 8px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 12px; box-sizing: border-box; margin-bottom: 8px; background: #FFFFFF; color: var(--text-primary); box-shadow: var(--shadow-input);">
          <option value="">Загрузка flows...</option>
        </select>
        <button id="useSelectedFlow" class="btn-secondary" style="width: 100%; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          Выбрать сценарий
        </button>
      </div>
      
      <div class="status" id="importStatus" style="margin-top: 0; margin-bottom: 8px;"></div>
    </div>
    
    <div class="info" id="info" style="display: none;"></div>
    
    <!-- Task Description -->
    <div id="taskDescriptionContainer" style="margin-bottom: 16px;">
      <div style="display: flex; align-items: center; margin-bottom: 6px;">
        <label for="taskDescription" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Введите суть задания</label>
        <span style="margin-left: 8px; font-size: 11px; color: var(--text-secondary);">0/250</span>
        <div class="tooltip-wrapper" style="margin-left: 4px;">
          <span class="tooltip-icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
          </span>
          <div class="tooltip">Пример: Найдите способ добавить товар в корзину и перейти к оформлению заказа</div>
        </div>
      </div>
      <textarea 
        id="taskDescription" 
        placeholder="Текст задания"
        maxlength="250"
        style="width: 100%; padding: 8px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 12px; font-family: Arial, sans-serif; box-sizing: border-box; resize: vertical; min-height: 60px; background: #FFFFFF; color: var(--text-primary); box-shadow: var(--shadow-input);"
      ></textarea>
      <div class="char-count" id="charCount" style="font-size: 11px; color: var(--text-secondary); text-align: right; margin-top: 4px;">0 / 250</div>
    </div>
    
    <!-- Attach to Study -->
    <div id="attachToStudyContainer" style="margin-bottom: 16px;">
      <label style="display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; font-weight: 500; cursor: pointer; color: var(--text-primary);">
        <input 
          type="checkbox" 
          id="attachToStudyToggle" 
          style="margin-right: 8px; cursor: pointer; width: 16px; height: 16px;"
        />
        <span>Тест уже создан (опционально)</span>
        <div class="tooltip-wrapper" style="margin-left: 4px;">
          <span class="tooltip-icon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
          </span>
          <div class="tooltip">Когда надо добавить в уже созданный тест, иначе будет создан новый тест</div>
        </div>
      </label>
      
      <div id="studySelectContainer" style="display: none; margin-top: 8px;">
        <select 
          id="studySelect" 
          style="width: 100%; padding: 6px 8px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 12px; box-sizing: border-box; background: #FFFFFF; color: var(--text-primary); box-shadow: var(--shadow-input);"
        >
          <option value="">Загрузка studies...</option>
        </select>
        <div id="attachError" style="display: none; margin-top: 8px; padding: 8px; background: #ffebee; color: #c62828; border-radius: 4px; font-size: 11px;"></div>
        <div id="attachRetryContainer" style="display: none; margin-top: 8px;">
          <button 
            id="retryAttachBtn" 
            class="btn-primary"
            style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
          >
            Retry attach
          </button>
        </div>
      </div>
    </div>
    
    <!-- Кнопка отправки -->
    <button id="sendToTest" class="btn-primary" style="width: 100%; margin-top: 16px;">Отправить на тест</button>
    <div class="status" id="status"></div>
    <div class="url-container" id="urlContainer">
      <label style="font-size: 12px; display: block; margin-bottom: 4px; color: var(--text-primary);">Ссылка для респондента:</label>
      <input type="text" class="url-input" id="testUrl" readonly />
      <button class="url-copy-btn" id="copyUrl">Копировать ссылку</button>
    </div>
  </div>
  
  <!-- Контент таба "Настройки" -->
  <div id="settingsTabContent" class="tab-content">
    <!-- Форма настройки (онбординг) -->
    <div id="settingsForm" class="settings-form">
    <div style="margin-bottom: 20px;">
      <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 14px; font-weight: 500;">Supabase и токен доступа</h3>
      
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
          <label for="supabaseUrl" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Supabase ссылка</label>
          <div class="tooltip-wrapper" style="margin-left: 4px;">
            <span class="tooltip-icon">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
            </span>
            <div class="tooltip">Найдите в Supabase Dashboard → Settings → API</div>
          </div>
        </div>
        <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
          <label for="supabaseKey" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Supabase Anon Key</label>
          <div class="tooltip-wrapper" style="margin-left: 4px;">
            <span class="tooltip-icon">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
            </span>
            <div class="tooltip">Anon/public ключ из Settings → API (длинная строка, начинается с eyJ...)</div>
          </div>
        </div>
        <input type="text" id="supabaseKey" placeholder="Вставьте сюда ключ" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center;">
              <label for="accessToken" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Токен доступа (для создания прототипа)</label>
              <div class="tooltip-wrapper" style="margin-left: 4px;">
                <span class="tooltip-icon">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
                </span>
                <div class="tooltip">Нажмите "Получить" чтобы открыть приложение аналитики для авторизации. После входа скопируйте токен со страницы /token и вставьте его сюда. Используйте access_token из страницы /token, НЕ anon_key!</div>
              </div>
            </div>
          </div>
          <button id="openAuth" class="btn-secondary" style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
            Получить
          </button>
        </div>
        <input type="text" id="accessToken" placeholder="Вставьте сюда токен" />
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 14px; font-weight: 500;">Аналитика и прохождение тестов</h3>
      
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
          <label for="viewerUrl" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Ссылка для прохождения тестов (Viewer)</label>
          <div class="tooltip-wrapper" style="margin-left: 4px;">
            <span class="tooltip-icon">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
            </span>
            <div class="tooltip">URL приложения figma-viewer (для прохождения тестов респондентами). Для локальной разработки: http://localhost:5173, для production: https://your-viewer-domain.com</div>
          </div>
        </div>
        <input type="text" id="viewerUrl" placeholder="Укажите URL" />
      </div>
      
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; margin-bottom: 6px;">
          <label for="analyticsUrl" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Ссылка для аналитики тестов (Analytics)</label>
          <div class="tooltip-wrapper" style="margin-left: 4px;">
            <span class="tooltip-icon">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
            </span>
            <div class="tooltip">URL приложения figma-analytics (для просмотра аналитики и получения токена). Для локальной разработки: http://localhost:5174, для production: https://your-analytics-domain.com</div>
          </div>
        </div>
        <input type="text" id="analyticsUrl" placeholder="Укажите URL" />
      </div>
    </div>
    
    <div style="margin-bottom: 20px;">
      <h3 style="margin: 0 0 16px 0; color: var(--text-primary); font-size: 14px; font-weight: 500;">Figma токен</h3>
      
      <div style="margin-bottom: 16px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center;">
              <label for="figmaToken" style="font-size: 12px; font-weight: 500; color: var(--text-primary); margin: 0;">Figma токен</label>
              <div class="tooltip-wrapper" style="margin-left: 4px;">
                <span class="tooltip-icon">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg>
                </span>
                <div class="tooltip">Требуется для импорта прототипов по Share ссылке через REST API. Получить можно в Figma Settings → Personal Access Tokens. Опционально: нужен только если используете режим "По Share ссылке"</div>
              </div>
            </div>
          </div>
          <button id="openFigmaSettings" class="btn-secondary" style="padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap;">
            Получить
          </button>
        </div>
        <input type="text" id="figmaToken" placeholder="Укажите токен" />
      </div>
    </div>
    
    <div class="settings-buttons">
      <button id="saveSettings">Сохранить настройки</button>
      <button id="cancelSettings" class="btn-secondary">Отмена</button>
    </div>
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #ddd;">
      <button id="resetSettings" class="btn-secondary" style="width: 100%; margin-bottom: 0; font-size: 12px; padding: 6px 10px; display: flex; align-items: center; justify-content: center; gap: 6px;">
        <span class="icon-svg"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C5.87827 0 3.84344 0.842854 2.34315 2.34315C0.842855 3.84344 0 5.87827 0 8C0 10.1217 0.842855 12.1566 2.34315 13.6569C3.84344 15.1571 5.87827 16 8 16C10.1217 16 12.1566 15.1571 13.6569 13.6569C15.1571 12.1566 16 10.1217 16 8C16 5.87827 15.1571 3.84344 13.6569 2.34315C12.1566 0.842854 10.1217 0 8 0ZM12.2426 12.2426C11.1174 13.3679 9.5913 14 8 14C6.4087 14 4.88258 13.3679 3.75736 12.2426C2.63214 11.1174 2 9.5913 2 8C2 6.4087 2.63214 4.88258 3.75736 3.75736C4.88258 2.63214 6.4087 2 8 2C9.5913 2 11.1174 2.63214 12.2426 3.75736C13.3679 4.88258 14 6.4087 14 8C14 9.5913 13.3679 11.1174 12.2426 12.2426ZM7.43998 5.80083C7.64364 5.68107 7.88312 5.6373 8.11597 5.67725C8.34883 5.71721 8.56002 5.83832 8.7121 6.01912C8.86419 6.19992 8.94735 6.42872 8.94684 6.66498V6.66712C8.94684 6.80271 8.83181 7.04179 8.39209 7.33497C8.2027 7.46125 8.0062 7.56024 7.8531 7.6283C7.77797 7.66171 7.71675 7.68613 7.67666 7.70141C7.65669 7.70902 7.64222 7.71427 7.63416 7.71713L7.6272 7.71958C7.10538 7.89557 6.82384 8.46066 6.99821 8.98349C7.17293 9.5074 7.7393 9.79048 8.26321 9.61575L7.95113 8.67996C8.26322 9.61575 8.26442 9.61535 8.26442 9.61535L8.26581 9.61488L8.26917 9.61375L8.27808 9.6107L8.30445 9.60147C8.32568 9.59391 8.35418 9.58352 8.3889 9.57029C8.45818 9.54389 8.55322 9.50579 8.66559 9.45583C8.88749 9.35718 9.19098 9.20611 9.50159 8.99901C10.0615 8.62566 10.9458 7.86542 10.9468 6.66925L10.9468 6.66712H9.94684L10.9468 6.66925C10.9484 5.96048 10.6989 5.27406 10.2426 4.73166C9.78635 4.18927 9.15279 3.82594 8.45423 3.70606C7.75566 3.58619 7.03721 3.71752 6.42623 4.07678C5.81525 4.43604 5.3512 5.00002 5.11634 5.66875C4.93333 6.18983 5.2074 6.76061 5.72848 6.94362C6.24956 7.12663 6.82034 6.85256 7.00335 6.33148C7.08163 6.10857 7.23632 5.92058 7.43998 5.80083ZM7.99984 10.3341C7.44756 10.3341 6.99984 10.7818 6.99984 11.3341C6.99984 11.8864 7.44756 12.3341 7.99984 12.3341H8.00684C8.55913 12.3341 9.00684 11.8864 9.00684 11.3341C9.00684 10.7818 8.55913 10.3341 8.00684 10.3341H7.99984Z" fill="#1B1F3B" fill-opacity="0.4"/></svg></span>
        Сбросить настройки (для тестирования)
      </button>
      <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px; text-align: center;">
        Удалит сохраненную конфигурацию и покажет форму онбординга
      </div>
    </div>
  </div>


  <script>
    // Конфигурация Supabase (получаем от code.js через postMessage)
    // Fallback значения на случай, если конфигурация не получена
    let SUPABASE_URL = "";
    let SUPABASE_ANON_KEY = "";
    let VIEWER_URL = "";
    let ANALYTICS_URL = "";
    let ACCESS_TOKEN = "";
    let configLoaded = false;
    
    // Для REST API подхода
    let FIGMA_ACCESS_TOKEN = ""; // Personal Access Token для Figma REST API
    let currentFileData = null; // Данные из REST API
    let currentFileKey = null; // fileKey из Share ссылки (для figmaFileId)
    let availableFlows = []; // Найденные flows (starting points)

    let latestData = null;
    let currentSelectedFlowId = null; // Хранит ID выбранного flow
    let studies = []; // Список studies пользователя
    let lastCreatedPrototypeId = null; // ID последнего созданного прототипа (для retry attach)

    // Проверка валидности конфигурации
    function isValidConfig() {
      return SUPABASE_URL && 
             SUPABASE_ANON_KEY && 
             VIEWER_URL &&
             SUPABASE_URL.startsWith("https://") &&
             VIEWER_URL.startsWith("http");
    }

    // Показать/скрыть форму настройки (обновлено для работы с табами)
    function showSettingsForm() {
      switchTab('settings');
      
      // Заполнить поля текущими значениями
      document.getElementById("supabaseUrl").value = SUPABASE_URL || "";
      document.getElementById("supabaseKey").value = SUPABASE_ANON_KEY || "";
      document.getElementById("viewerUrl").value = VIEWER_URL || "";
      document.getElementById("analyticsUrl").value = ANALYTICS_URL || "";
      document.getElementById("accessToken").value = ACCESS_TOKEN || "";
      document.getElementById("figmaToken").value = FIGMA_ACCESS_TOKEN || "";
    }

    function hideSettingsForm() {
      if (isValidConfig()) {
        switchTab('prototype');
      }
    }

    // Сохранение настроек
    function saveSettings() {
      const url = document.getElementById("supabaseUrl").value.trim();
      const key = document.getElementById("supabaseKey").value.trim();
      const viewer = document.getElementById("viewerUrl").value.trim();
      const analytics = document.getElementById("analyticsUrl").value.trim();
      const token = document.getElementById("accessToken").value.trim();
      const figmaToken = document.getElementById("figmaToken").value.trim();

      // Валидация
      if (!url || !url.startsWith("https://")) {
        showStatus("⚠️ Укажите корректный Supabase URL (начинается с https://)", "error");
        return;
      }
      if (!key || key.length < 50) {
        showStatus("⚠️ Укажите корректный Supabase Anon Key", "error");
        return;
      }
      if (!viewer || (!viewer.startsWith("http://") && !viewer.startsWith("https://"))) {
        showStatus("⚠️ Укажите корректный Viewer URL (начинается с http:// или https://)", "error");
        return;
      }

      // Обновляем конфигурацию
      SUPABASE_URL = url;
      SUPABASE_ANON_KEY = key;
      VIEWER_URL = viewer;
      ANALYTICS_URL = analytics;
      ACCESS_TOKEN = token;
      FIGMA_ACCESS_TOKEN = figmaToken; // Сохраняем Figma Personal Access Token

      // Отправляем в code.js для сохранения
      parent.postMessage({
        pluginMessage: {
          type: "SAVE_CONFIG",
          config: {
            SUPABASE_URL: url,
            SUPABASE_ANON_KEY: key,
            VIEWER_URL: viewer,
            ANALYTICS_URL: analytics,
            ACCESS_TOKEN: token,
            FIGMA_ACCESS_TOKEN: figmaToken
          }
        }
      }, "*");

      showStatus("✓ Настройки сохранены!", "success");
      setTimeout(() => {
        switchTab('prototype');
      }, 1000);
    }

    // Инициализация: проверяем конфигурацию при загрузке
    function initUI() {
      if (!isValidConfig()) {
        // Показываем таб настроек, если конфигурация не валидна
        switchTab('settings');
      } else {
        // Показываем таб прототипа
        switchTab('prototype');
        // Загружаем studies если toggle включен
        if (document.getElementById("attachToStudyToggle") && document.getElementById("attachToStudyToggle").checked) {
          loadStudies();
        }
      }
    }
    
    // Загрузка списка studies
    async function loadStudies() {
      console.log("loadStudies called");
      const studySelect = document.getElementById("studySelect");
      studySelect.innerHTML = '<option value="">Загрузка studies...</option>';
      studySelect.disabled = true;
      
      try {
        console.log("ACCESS_TOKEN exists:", !!ACCESS_TOKEN, "length:", ACCESS_TOKEN ? ACCESS_TOKEN.length : 0);
        console.log("SUPABASE_URL:", SUPABASE_URL);
        
        if (!ACCESS_TOKEN || !ACCESS_TOKEN.trim()) {
          console.log("No ACCESS_TOKEN, showing error");
          studySelect.innerHTML = '<option value="">Требуется access token</option>';
          return;
        }
        
        // Получаем user_id из access token
        console.log("Fetching user data...");
        const userResponse = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          headers: {
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "apikey": SUPABASE_ANON_KEY
          }
        });
        
        console.log("User response status:", userResponse.status);
        
        if (!userResponse.ok) {
          const errorText = await userResponse.text();
          console.error("Auth error:", errorText);
          studySelect.innerHTML = '<option value="">Ошибка авторизации</option>';
          return;
        }
        
        const userData = await userResponse.json();
        const userId = userData.id;
        console.log("User ID:", userId);
        
        // Сначала получаем team_id пользователя через team_members
        const teamMembersUrl = `${SUPABASE_URL}/rest/v1/team_members?user_id=eq.${userId}&select=team_id`;
        console.log("Fetching team_members from:", teamMembersUrl);
        
        const teamMembersResponse = await fetch(teamMembersUrl, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Content-Type": "application/json"
          }
        });
        
        if (!teamMembersResponse.ok) {
          console.error("Team members fetch error:", await teamMembersResponse.text());
          studySelect.innerHTML = '<option value="">Ошибка загрузки команд</option>';
          return;
        }
        
        const teamMembers = await teamMembersResponse.json() || [];
        console.log("Team members:", teamMembers);
        
        if (teamMembers.length === 0) {
          console.log("User is not in any team");
          studySelect.innerHTML = '<option value="">Нет доступных teams</option>';
          return;
        }
        
        // Получаем все team_id пользователя
        const teamIds = teamMembers.map(tm => tm.team_id);
        console.log("Team IDs:", teamIds);
        
        // Загружаем studies по team_id (используем in для нескольких команд)
        const teamIdsFilter = teamIds.map(id => `"${id}"`).join(',');
        const studiesUrl = `${SUPABASE_URL}/rest/v1/studies?team_id=in.(${teamIdsFilter})&select=id,title,status&order=created_at.desc`;
        console.log("Fetching studies from:", studiesUrl);
        
        const studiesResponse = await fetch(studiesUrl, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Content-Type": "application/json"
          }
        });
        
        console.log("Studies response status:", studiesResponse.status);
        
        if (!studiesResponse.ok) {
          const errorText = await studiesResponse.text();
          console.error("Studies fetch error:", errorText);
          studySelect.innerHTML = '<option value="">Ошибка загрузки studies</option>';
          return;
        }
        
        studies = await studiesResponse.json() || [];
        console.log("Studies loaded:", studies.length, studies);
        
        // Обновляем select
        studySelect.innerHTML = '<option value="">Выберите Study (опционально)</option>';
        studies.forEach(study => {
          const option = document.createElement("option");
          option.value = study.id;
          option.textContent = `${study.title} (${study.status === "published" ? "Published" : "Draft"})`;
          studySelect.appendChild(option);
        });
        
        studySelect.disabled = false;
        console.log("Studies select updated, options count:", studySelect.options.length);
      } catch (error) {
        console.error("Error loading studies:", error);
        studySelect.innerHTML = '<option value="">Ошибка загрузки</option>';
      }
    }
    
    // Прикрепление прототипа к Study
    async function attachToStudy(prototypeId, studyId, instructions) {
      try {
        if (!ACCESS_TOKEN || !ACCESS_TOKEN.trim()) {
          throw new Error("Access token required");
        }
        
        // Получаем максимальный order_index для этого study
        const blocksResponse = await fetch(`${SUPABASE_URL}/rest/v1/study_blocks?study_id=eq.${studyId}&select=order_index&order=order_index.desc&limit=1`, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Content-Type": "application/json"
          }
        });
        
        let maxOrderIndex = -1;
        if (blocksResponse.ok) {
          const blocks = await blocksResponse.json() || [];
          if (blocks.length > 0) {
            maxOrderIndex = blocks[0].order_index;
          }
        }
        
        const orderIndex = maxOrderIndex + 1;
        
        // Создаем study_block
        const blockBody = {
          study_id: studyId,
          type: "prototype",
          prototype_id: prototypeId,
          instructions: instructions || null,
          order_index: orderIndex,
          config: {}
        };
        
        const blockResponse = await fetch(`${SUPABASE_URL}/rest/v1/study_blocks`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Prefer": "return=representation"
          },
          body: JSON.stringify(blockBody)
        });
        
        if (!blockResponse.ok) {
          const errorText = await blockResponse.text();
          throw new Error(`Ошибка прикрепления к Study: ${blockResponse.status} - ${errorText}`);
        }
        
        return true;
      } catch (error) {
        console.error("Error attaching to study:", error);
        throw error;
      }
    }
    
    // Создание нового study
    async function createStudy(title, teamId) {
      try {
        if (!ACCESS_TOKEN || !ACCESS_TOKEN.trim()) {
          throw new Error("Access token required");
        }
        
        const studyBody = {
          title: title || "Новый тест",
          team_id: teamId,
          status: "draft"
        };
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/studies`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Prefer": "return=representation"
          },
          body: JSON.stringify(studyBody)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Ошибка создания Study: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log("Created study:", data);
        return data[0]; // Возвращаем созданный study
      } catch (error) {
        console.error("Error creating study:", error);
        throw error;
      }
    }
    
    // Получение team_id пользователя
    async function getUserTeamId(userId) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/team_members?user_id=eq.${userId}&select=team_id&limit=1`, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Content-Type": "application/json"
          }
        });
        
        if (!response.ok) {
          throw new Error("Ошибка получения team_id");
        }
        
        const data = await response.json();
        if (data && data.length > 0) {
          return data[0].team_id;
        }
        return null;
      } catch (error) {
        console.error("Error getting team_id:", error);
        return null;
      }
    }
    
    // Получение share_token для study
    async function getStudyShareToken(studyId) {
      try {
        // Сначала проверяем, есть ли уже share
        const existingResponse = await fetch(`${SUPABASE_URL}/rest/v1/study_shares?study_id=eq.${studyId}&mode=eq.respond&revoked_at=is.null&select=token&limit=1`, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Content-Type": "application/json"
          }
        });
        
        if (existingResponse.ok) {
          const existing = await existingResponse.json();
          if (existing && existing.length > 0) {
            console.log("Found existing share token:", existing[0].token);
            return existing[0].token;
          }
        }
        
        // Если нет, создаем новый share
        const shareBody = {
          study_id: studyId,
          mode: "respond",
          access: "any"
        };
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/study_shares`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
            "Prefer": "return=representation"
          },
          body: JSON.stringify(shareBody)
        });
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Ошибка создания share: ${response.status} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log("Created share token:", data[0].token);
        return data[0].token;
      } catch (error) {
        console.error("Error getting share token:", error);
        throw error;
      }
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      // Получаем конфигурацию от code.js
      if (msg.type === "CONFIG" && msg.config) {
        // Если конфигурация пустая (после сброса), используем пустые строки
        SUPABASE_URL = msg.config.SUPABASE_URL || "";
        SUPABASE_ANON_KEY = msg.config.SUPABASE_ANON_KEY || "";
        VIEWER_URL = msg.config.VIEWER_URL || "";
        ANALYTICS_URL = msg.config.ANALYTICS_URL || "";
        ACCESS_TOKEN = msg.config.ACCESS_TOKEN || "";
        FIGMA_ACCESS_TOKEN = msg.config.FIGMA_ACCESS_TOKEN || "";
        configLoaded = true;
        console.log("Config received from code.js:", { SUPABASE_URL, VIEWER_URL, ANALYTICS_URL });
        
        // Инициализируем UI после получения конфигурации
        initUI();
      }

      if (msg.type === "EXPORT_JSON") {
        latestData = msg.data;

        const info = msg.info || {};
        const infoEl = document.getElementById("info");
        
        // БЕЗОПАСНО: Используем textContent и создание элементов вместо innerHTML для предотвращения XSS
        // Функция для экранирования HTML сущностей
        function escapeHtml(text) {
          if (!text) return "";
          const div = document.createElement("div");
          div.textContent = text;
          return div.innerHTML;
        }
        
        // Безопасно создаем HTML, экранируя пользовательские данные
        const startFrameName = escapeHtml(info.startFrameName || "не определен");
        const endFrameName = escapeHtml(info.endFrameName || "не определен");
        const endFrameId = escapeHtml(info.endFrameId || latestData.end);
        const endFrameMarker = info.endFrameFoundByMarker ? " ✓" : " ⚠️ (автоопределение)";
        
        infoEl.innerHTML =
          "<strong>Стартовый:</strong> " + startFrameName + "<br>" +
          "<strong>Финальный:</strong> " + endFrameName + endFrameMarker + "<br>" +
          "<small>ID финального: " + endFrameId + "</small>" +
          (!info.endFrameFoundByMarker ? "<br><small style='color: #ff9800;'>💡 Добавьте [final] в название финального фрейма</small>" : "");
        
        // Показываем уведомление
        showImportStatus("✓ Прототип сгенерирован из Share ссылки! Теперь можно отправить на тест.", "success");
      }
      
      // Обработка ответов от code.js для получения данных файла (используется внутри getFileDataFromREST)
      // Эти сообщения обрабатываются через Promise в getFileDataFromREST, но можно добавить дополнительную обработку
    };

    document.getElementById("sendToTest").onclick = async () => {
      if (!latestData) {
        showStatus("JSON пока не получен", "error");
        return;
      }

      // Проверяем конфигурацию перед отправкой
      if (!isValidConfig()) {
        showStatus("⚠️ Сначала настройте плагин (нажмите ⚙️)", "error");
        showSettingsForm();
        return;
      }

      const statusEl = document.getElementById("status");
      const sendBtn = document.getElementById("sendToTest");
      const urlContainer = document.getElementById("urlContainer");

      sendBtn.disabled = true;
      showStatus("Отправка в Supabase...", "loading");

      try {
        // Генерируем UUID только для прототипа
        // Сессия будет создаваться только при открытии ссылки в браузере
        const prototypeId = generateUUID();
        
        // Получаем задание из поля ввода
        const taskDescription = document.getElementById("taskDescription").value.trim();
        
        // Валидация задания
        if (!taskDescription || taskDescription.length === 0) {
          showStatus("⚠️ Пожалуйста, введите задание для респондента", "error");
          sendBtn.disabled = false;
          return;
        }
        
        if (taskDescription.length > 250) {
          showStatus("⚠️ Задание не должно превышать 250 символов", "error");
          sendBtn.disabled = false;
          return;
        }

        // Получаем user_id из access token (если он указан)
        // ВАЖНО: ACCESS_TOKEN должен быть access_token от авторизованного пользователя, НЕ anon_key!
        let userId = null;
        let useAccessToken = false;
        if (ACCESS_TOKEN && ACCESS_TOKEN.trim()) {
          // Проверяем, что это не anon_key (anon key обычно короче и начинается с eyJ, но не является access_token)
          // Простая проверка: access_token обычно длиннее и работает с /auth/v1/user
          try {
            const userResponse = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
              headers: {
                "Authorization": `Bearer ${ACCESS_TOKEN.trim()}`,
                "apikey": SUPABASE_ANON_KEY
              }
            });
            if (userResponse.ok) {
              const userData = await userResponse.json();
              userId = userData.id;
              useAccessToken = true;
              console.log("Access token valid, user_id:", userId);
            } else {
              // Если запрос не успешен, токен невалидный
              console.warn("Access token invalid or expired. Error:", userResponse.status);
              showStatus("⚠️ Access token недействителен. Прототип не может быть создан без привязки к аккаунту. Пожалуйста, обновите access token на странице /token", "warning");
            }
          } catch (error) {
            console.error("Error validating access token:", error);
            // Если ошибка при проверке токена, не создаем прототип
            showStatus("⚠️ Ошибка проверки access token. Прототип не может быть создан без привязки к аккаунту. Пожалуйста, обновите access token на странице /token", "warning");
          }
        }

        // КРИТИЧНО: Прототип должен быть создан с user_id
        // Если userId отсутствует, не создаем прототип
        if (!userId) {
          showStatus("❌ Ошибка: Не удалось получить user_id из access token. Прототип не может быть создан без привязки к аккаунту. Пожалуйста, обновите access token на странице /token", "error");
          sendBtn.disabled = false;
          return;
        }
        
        // 1. Создаем прототип в Supabase
        // ВАЖНО: flowId сохраняется в JSON данных прототипа (latestData.flowId), а не в отдельной колонке БД
        const prototypeBody = {
          id: prototypeId,
          data: latestData, // latestData уже содержит flowId в JSON (добавлено в code.js)
          task_description: taskDescription,
          user_id: userId  // Обязательно добавляем user_id
        };

        // Используем access_token только если он валидный, иначе используем anon_key
        const authHeader = useAccessToken && ACCESS_TOKEN 
          ? `Bearer ${ACCESS_TOKEN.trim()}` 
          : `Bearer ${SUPABASE_ANON_KEY}`;

        let prototypeResponse = await fetch(`${SUPABASE_URL}/rest/v1/prototypes`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": authHeader,
            "Prefer": "return=representation"
          },
          body: JSON.stringify(prototypeBody)
        });

        if (!prototypeResponse.ok) {
          const errorText = await prototypeResponse.text();
          
          // Специальная обработка ошибки невалидного JWT токена
          if (prototypeResponse.status === 401 && errorText.includes("JWT")) {
            console.warn("Invalid access token format, cannot create prototype without user_id");
            
            // КРИТИЧНО: Не создаем прототип без user_id
            // Прототипы должны быть привязаны к пользователю для правильной изоляции данных
            showStatus("❌ Ошибка: Неверный access token. Прототип не может быть создан без привязки к аккаунту. Пожалуйста, обновите access token на странице /token", "error");
            sendBtn.disabled = false;
            return;
          } else {
            throw new Error(`Ошибка создания прототипа: ${prototypeResponse.status} - ${errorText}`);
          }
        }

        // Сохраняем prototypeId для возможного retry attach
        lastCreatedPrototypeId = prototypeId;
        
        // 2. Определяем study_id - либо выбранный, либо создаем новый
        const attachToStudyToggle = document.getElementById("attachToStudyToggle");
        const studySelect = document.getElementById("studySelect");
        const attachError = document.getElementById("attachError");
        const attachRetryContainer = document.getElementById("attachRetryContainer");
        
        let studyId = null;
        let studyTitle = taskDescription || "Новый тест";
        
        try {
          if (attachToStudyToggle && attachToStudyToggle.checked && studySelect && studySelect.value) {
            // Используем выбранный study
            studyId = studySelect.value;
            console.log("Using selected study:", studyId);
          } else {
            // Создаем новый study
            console.log("Creating new study with title:", studyTitle);
            
            // Получаем team_id пользователя
            const teamId = await getUserTeamId(userId);
            if (!teamId) {
              throw new Error("Не удалось получить team_id. Убедитесь, что вы состоите в команде.");
            }
            
            const newStudy = await createStudy(studyTitle, teamId);
            studyId = newStudy.id;
            console.log("Created new study:", studyId);
          }
          
          // 3. Прикрепляем прототип к study
          await attachToStudy(prototypeId, studyId, taskDescription);
          console.log("Prototype attached to study:", studyId);
          
          // 4. Получаем share_token для study
          const shareToken = await getStudyShareToken(studyId);
          console.log("Got share token:", shareToken);
          
          // 5. Генерируем URL для study через share token
          const viewerUrl = VIEWER_URL.endsWith('/') ? VIEWER_URL.slice(0, -1) : VIEWER_URL;
          const testUrl = `${viewerUrl}/share/${shareToken}`;
          document.getElementById("testUrl").value = testUrl;
          urlContainer.classList.add("show");
          
          // Очищаем ошибки при успехе
          if (attachError) attachError.style.display = "none";
          if (attachRetryContainer) attachRetryContainer.style.display = "none";
          
          showStatus("✓ Прототип успешно добавлен в тест! Скопируйте ссылку.", "success");
          
        } catch (studyErr) {
          console.error("Error with study:", studyErr);
          
          // Fallback: показываем ошибку, но даем прямую ссылку на прототип
          const viewerUrl = VIEWER_URL.endsWith('/') ? VIEWER_URL.slice(0, -1) : VIEWER_URL;
          const fallbackUrl = `${viewerUrl}/prototype/${prototypeId}`;
          document.getElementById("testUrl").value = fallbackUrl;
          urlContainer.classList.add("show");
          
          if (attachError) {
            attachError.textContent = `⚠️ Прототип создан, но не удалось привязать к тесту: ${studyErr.message}. Используйте прямую ссылку.`;
            attachError.style.display = "block";
          }
          showStatus("⚠️ Прототип создан, но не привязан к тесту. См. ошибку ниже.", "error");
        }

      } catch (error) {
        console.error("Error:", error);
        showStatus(`Ошибка: ${error.message}`, "error");
      } finally {
        sendBtn.disabled = false;
      }
    };

    document.getElementById("copyUrl").onclick = () => {
      const urlInput = document.getElementById("testUrl");
      urlInput.select();
      document.execCommand("copy");
      showStatus("✓ Ссылка скопирована в буфер обмена!", "success");
      setTimeout(() => {
        const statusEl = document.getElementById("status");
        statusEl.classList.remove("success");
        statusEl.classList.remove("show");
      }, 2000);
    };

    function showStatus(message, type) {
      const statusEl = document.getElementById("status");
      statusEl.textContent = message;
      statusEl.className = "status " + type;
    }
    
    // Функция для показа статуса импорта (показывается под кнопкой "Импортировать прототип")
    function showImportStatus(message, type) {
      const importStatusEl = document.getElementById("importStatus");
      importStatusEl.textContent = message;
      importStatusEl.className = "status " + type;
    }

    // Обновление счетчика символов
    const taskDescriptionInput = document.getElementById("taskDescription");
    const charCountEl = document.getElementById("charCount");
    
    taskDescriptionInput.addEventListener("input", () => {
      const length = taskDescriptionInput.value.length;
      charCountEl.textContent = `${length} / 250`;
      if (length > 250) {
        charCountEl.className = "char-count error";
      } else if (length > 200) {
        charCountEl.className = "char-count warning";
      } else {
        charCountEl.className = "char-count";
      }
    });

    // Сброс настроек
    function resetSettings() {
      if (confirm("Вы уверены, что хотите сбросить настройки? Это удалит сохраненную конфигурацию.")) {
        // Отправляем запрос на удаление конфигурации
        parent.postMessage({
          pluginMessage: {
            type: "RESET_CONFIG"
          }
        }, "*");

        // Очищаем локальные переменные
        SUPABASE_URL = "";
        SUPABASE_ANON_KEY = "";
        VIEWER_URL = "";
        ANALYTICS_URL = "";
        ACCESS_TOKEN = "";
        FIGMA_ACCESS_TOKEN = "";

        // Очищаем поля формы
        document.getElementById("supabaseUrl").value = "";
        document.getElementById("supabaseKey").value = "";
        document.getElementById("viewerUrl").value = "";
        document.getElementById("analyticsUrl").value = "";
        document.getElementById("accessToken").value = "";
        document.getElementById("figmaToken").value = "";

        showSettingsForm();

        showStatus("✓ Настройки сброшены! Заполните форму заново.", "success");
      }
    }

    // Табы
    function switchTab(tabName) {
      // Убираем активный класс у всех табов и контента
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Активируем выбранный таб
      if (tabName === 'prototype') {
        document.getElementById('prototypeTab').classList.add('active');
        document.getElementById('prototypeTabContent').classList.add('active');
      } else if (tabName === 'settings') {
        document.getElementById('settingsTab').classList.add('active');
        document.getElementById('settingsTabContent').classList.add('active');
        // Загружаем данные в поля при переключении на таб настроек
        document.getElementById("supabaseUrl").value = SUPABASE_URL || "";
        document.getElementById("supabaseKey").value = SUPABASE_ANON_KEY || "";
        document.getElementById("viewerUrl").value = VIEWER_URL || "";
        document.getElementById("analyticsUrl").value = ANALYTICS_URL || "";
        document.getElementById("accessToken").value = ACCESS_TOKEN || "";
        document.getElementById("figmaToken").value = FIGMA_ACCESS_TOKEN || "";
      }
    }
    
    document.getElementById('prototypeTab').onclick = () => switchTab('prototype');
    document.getElementById('settingsTab').onclick = () => switchTab('settings');
    
    
    // Обработчики для формы настройки
    document.getElementById("saveSettings").onclick = saveSettings;
    document.getElementById("openAuth").onclick = () => {
      // Получаем URL из поля ввода (если форма открыта) или из глобальной переменной
      const analyticsUrlInput = document.getElementById("analyticsUrl");
      const analyticsUrlValue = analyticsUrlInput ? analyticsUrlInput.value.trim() : "";
      const analyticsUrlToUse = analyticsUrlValue || ANALYTICS_URL;
      
      if (!analyticsUrlToUse) {
        showStatus("⚠️ Сначала укажите Analytics URL в настройках", "error");
        return;
      }
      
      // Убираем лишний слэш, если URL заканчивается на /
      const analyticsUrl = analyticsUrlToUse.endsWith('/') ? analyticsUrlToUse.slice(0, -1) : analyticsUrlToUse;
      const authUrl = `${analyticsUrl}/token`;
      
      console.log("Opening auth URL:", authUrl);
      
      // Отправляем сообщение в code.js для открытия браузера
      try {
        // Используем window.parent для надежности
        const target = window.parent || parent;
        target.postMessage({ 
          pluginMessage: { 
            type: "OPEN_AUTH", 
            url: authUrl 
          } 
        }, "*");
        console.log("Message sent to code.js, URL:", authUrl);
        showStatus("✓ Открываю Analytics в браузере...", "loading");
      } catch (error) {
        console.error("Error sending message to code.js:", error);
        showStatus("❌ Ошибка при открытии браузера: " + error.message, "error");
      }
    };
    document.getElementById("cancelSettings").onclick = () => {
      if (isValidConfig()) {
        switchTab('prototype');
      } else {
        showStatus("⚠️ Настройки обязательны для работы плагина", "error");
      }
    };
    document.getElementById("resetSettings").onclick = resetSettings;
    
    // Обработчик для кнопки получения Figma токена
    const openFigmaSettingsBtn = document.getElementById("openFigmaSettings");
    if (openFigmaSettingsBtn) {
      openFigmaSettingsBtn.onclick = () => {
        window.open("https://www.figma.com/settings", "_blank");
      };
    }

    // Парсинг Figma Share ссылки
    function parseFigmaShareLink(url) {
      try {
        // Поддерживаем форматы:
        // 1. https://www.figma.com/design/{file_key}/{file_name}?node-id={node-id}&t=...
        // 2. https://www.figma.com/proto/{file_key}/{file_name}?node-id={node-id}&t=...
        // 3. https://www.figma.com/file/{file_key}/{file_name}?node-id={node-id}&t=...
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/').filter(p => p); // Убираем пустые части
        
        // Ищем design, proto или file в пути
        let fileKeyIndex = -1;
        const possibleTypes = ['design', 'proto', 'file'];
        
        for (let i = 0; i < pathParts.length; i++) {
          if (possibleTypes.includes(pathParts[i].toLowerCase()) && i + 1 < pathParts.length) {
            fileKeyIndex = i + 1;
            break;
          }
        }
        
        if (fileKeyIndex === -1 || fileKeyIndex >= pathParts.length) {
          console.warn("Could not find file key in URL:", url);
          return null;
        }
        
        const fileKey = pathParts[fileKeyIndex];
        const nodeId = urlObj.searchParams.get('node-id');
        
        // Декодируем node-id если он закодирован (например, "0%3A1" -> "0:1")
        const decodedNodeId = nodeId ? decodeURIComponent(nodeId) : null;
        
        console.log("Parsed Figma link:", { fileKey, nodeId: decodedNodeId, originalUrl: url });
        
        return { fileKey, nodeId: decodedNodeId };
      } catch (error) {
        console.error("Error parsing Figma share link:", error);
        return null;
      }
    }
    
    // Получение данных файла через REST API (через code.js для обхода CSP)
    function getFileDataFromREST(fileKey, figmaToken) {
      return new Promise((resolve, reject) => {
        // Создаем обработчик для ответа
        const messageHandler = (event) => {
          const msg = event.data.pluginMessage;
          if (msg.type === "FIGMA_FILE_FETCHED") {
            window.removeEventListener("message", messageHandler);
            resolve(msg.fileData);
          } else if (msg.type === "FIGMA_FILE_FETCH_ERROR") {
            window.removeEventListener("message", messageHandler);
            reject(new Error(msg.error));
          }
        };
        
        window.addEventListener("message", messageHandler);
        
        // Отправляем запрос в code.js
        parent.postMessage({
          pluginMessage: {
            type: "FETCH_FIGMA_FILE",
            fileKey: fileKey,
            figmaToken: figmaToken
          }
        }, "*");
        
        // Таймаут на случай, если ответ не придет
        setTimeout(() => {
          window.removeEventListener("message", messageHandler);
          reject(new Error("Timeout: не удалось получить данные файла"));
        }, 30000); // 30 секунд
      });
    }
    
    // Поиск starting points (flows) в данных файла
    // ВАЖНО: Всегда ищем все flows с prototypeStartingPoint === true (основной критерий для flows)
    // Если есть node-id в URL, добавляем его в список (но не дублируем, если он уже есть как prototypeStartingPoint)
    function findStartingPoints(fileData, nodeIdFromUrl = null) {
      const startingPoints = [];
      let totalFrames = 0;
      let framesWithReactions = 0;
      let urlFlowId = null; // ID flow из URL (будет использоваться для предвыбора)
      
      // Вспомогательная функция для поиска узла по ID
      function findNodeById(node, targetId) {
        if (!node) return null;
        if (node.id === targetId) return node;
        if (node.children) {
          for (const child of node.children) {
            const found = findNodeById(child, targetId);
            if (found) return found;
          }
        }
        return null;
      }
      
      // Если есть nodeId из URL, запоминаем его ID (но не добавляем сразу)
      // Будем добавлять только если его нет в списке flows с prototypeStartingPoint
      if (nodeIdFromUrl) {
        // Преобразуем формат "143-552" в "143:552" (REST API использует двоеточия)
        const normalizedNodeId = nodeIdFromUrl.replace(/-/g, ':');
        urlFlowId = normalizedNodeId;
        console.log("URL nodeId detected:", normalizedNodeId, "(will be added if not found in prototypeStartingPoint flows)");
      }
      
      // ВАЖНО: Сначала обходим документ и ищем ВСЕ flows с prototypeStartingPoint === true
      // Это основной критерий для flows в Figma (согласно REST API documentation)
      function traverseNode(node, path = []) {
        if (!node) return;
        
        // Считаем фреймы
        if (node.type === "FRAME") {
          totalFrames++;
          
          // Проверяем reactions на самом фрейме
          const hasReactions = node.reactions && Array.isArray(node.reactions) && node.reactions.length > 0;
          
          // Также проверяем, есть ли reactions на дочерних элементах
          let hasReactionsInChildren = false;
          if (node.children) {
            for (const child of node.children) {
              if (child.reactions && Array.isArray(child.reactions) && child.reactions.length > 0) {
                hasReactionsInChildren = true;
                break;
              }
            }
          }
          
          // ВАЖНО: Основной критерий для flow - prototypeStartingPoint === true
          // Согласно документации REST API, flows определяются через prototypeStartingPoint
          const isStartingPoint = node.prototypeStartingPoint === true;
          
          // Добавляем только flows с prototypeStartingPoint === true (явно помеченные как starting points)
          // Это соответствует логике Figma, где flows создаются через прототипирование
          if (isStartingPoint) {
            // Проверяем, не является ли это дубликатом
            const existing = startingPoints.find(sp => sp.id === node.id);
            if (!existing) {
              const isFromUrl = urlFlowId && node.id === urlFlowId;
              startingPoints.push({
                id: node.id,
                name: node.name || `Flow ${startingPoints.length + 1}`,
                path: [...path, node.name || node.id],
                isExplicit: true, // Явно помечен как starting point
                fromUrl: isFromUrl, // Отмечен, если это flow из URL
                hasReactions: hasReactions,
                hasReactionsInChildren: hasReactionsInChildren
              });
              console.log("Found prototypeStartingPoint flow:", node.name, node.id, isFromUrl ? "(from URL)" : "");
            }
          }
          
          // Также считаем frames с reactions для статистики
          if (hasReactions || hasReactionsInChildren) {
            framesWithReactions++;
          }
        }
        
        // Рекурсивно обходим дочерние узлы
        if (node.children) {
          node.children.forEach(child => {
            traverseNode(child, [...path, node.name || node.id]);
          });
        }
      }
      
      // ВАЖНО: Сначала проверяем fileData.flowStartingPoints
      // Согласно REST API документации, flows хранятся в массиве fileData.flowStartingPoints
      // Каждый flow имеет nodeId и name
      if (fileData.flowStartingPoints && Array.isArray(fileData.flowStartingPoints)) {
        console.log("Found flowStartingPoints in fileData:", fileData.flowStartingPoints.length, "flows");
        
        // Вспомогательная функция для поиска фрейма по ID
        function findFrameByIdInDocument(node, targetId) {
          if (!node) return null;
          if (node.id === targetId && node.type === "FRAME") return node;
          if (node.children) {
            for (const child of node.children) {
              const found = findFrameByIdInDocument(child, targetId);
              if (found) return found;
            }
          }
          return null;
        }
        
        // Получаем информацию о странице для каждого flow
        function getFramePath(node, targetId, path = []) {
          if (!node) return null;
          if (node.id === targetId && node.type === "FRAME") {
            return [...path, node.name || node.id];
          }
          if (node.children) {
            for (const child of node.children) {
              const result = getFramePath(child, targetId, [...path, node.name || node.id]);
              if (result) return result;
            }
          }
          return null;
        }
        
        fileData.flowStartingPoints.forEach(flow => {
          console.log("Processing flow from flowStartingPoints:", flow.name, flow.nodeId);
          
          let foundFrame = null;
          let framePath = null;
          
          // Ищем фрейм в документе
          if (fileData.document && fileData.document.children) {
            for (const page of fileData.document.children) {
              foundFrame = findFrameByIdInDocument(page, flow.nodeId);
              if (foundFrame) {
                framePath = getFramePath(page, flow.nodeId, [page.name || "Page"]);
                break;
              }
            }
          }
          
          if (foundFrame) {
            const existing = startingPoints.find(sp => sp.id === flow.nodeId);
            if (!existing) {
              const isFromUrl = urlFlowId && flow.nodeId === urlFlowId;
              startingPoints.push({
                id: flow.nodeId,
                name: flow.name || foundFrame.name || `Flow ${startingPoints.length + 1}`,
                path: framePath || [foundFrame.name || flow.nodeId],
                isExplicit: true, // Из flowStartingPoints - явно помечен
                fromUrl: isFromUrl,
                hasReactions: false,
                hasReactionsInChildren: false
              });
              console.log("✓ Added flow from fileData.flowStartingPoints:", flow.name, flow.nodeId, isFromUrl ? "(from URL)" : "");
            } else {
              // Обновляем существующий flow
              existing.name = flow.name || existing.name;
              existing.isExplicit = true;
              if (urlFlowId && flow.nodeId === urlFlowId) {
                existing.fromUrl = true;
              }
              console.log("✓ Updated existing flow from fileData.flowStartingPoints:", flow.name, flow.nodeId);
            }
          } else {
            console.warn("Flow frame not found in document:", flow.name, flow.nodeId);
          }
        });
      } else {
        console.log("No flowStartingPoints found in fileData, searching by prototypeStartingPoint property on frames");
      }
      
      // Также обходим документ и ищем все flows с prototypeStartingPoint === true
      // (на случай, если flowStartingPoints не заполнен, но flows есть)
      if (fileData.document && fileData.document.children) {
        fileData.document.children.forEach(page => {
          traverseNode(page, [page.name || "Page"]);
        });
      }
      
      // Если есть node-id в URL, но он не найден в flows с prototypeStartingPoint, добавляем его
      if (urlFlowId) {
        const urlFlowExists = startingPoints.find(sp => sp.id === urlFlowId);
        if (!urlFlowExists) {
          console.log("URL nodeId not found in prototypeStartingPoint flows, searching for it...");
          
          // Ищем узел из URL в документе
          if (fileData.document && fileData.document.children) {
            let foundNode = null;
            let foundPage = null;
            
            for (const page of fileData.document.children) {
              if (page.id === urlFlowId) {
                // Если nodeId указывает на страницу, ищем первый фрейм на этой странице
                if (page.children) {
                  for (const child of page.children) {
                    if (child.type === "FRAME") {
                      foundNode = child;
                      foundPage = page;
                      console.log("Found first FRAME on page from URL:", child.name, child.id);
                      break;
                    }
                  }
                }
                break;
              }
              
              foundNode = findNodeById(page, urlFlowId);
              if (foundNode) {
                foundPage = page;
                
                if (foundNode.type === "FRAME") {
                  break;
                } else {
                  // Если это не фрейм, ищем первый фрейм-потомок
                  function findFirstFrame(node) {
                    if (node.type === "FRAME") return node;
                    if (node.children) {
                      for (const child of node.children) {
                        const frame = findFirstFrame(child);
                        if (frame) return frame;
                      }
                    }
                    return null;
                  }
                  const firstFrame = findFirstFrame(foundNode);
                  if (firstFrame) {
                    foundNode = firstFrame;
                    break;
                  } else {
                    foundNode = null;
                  }
                }
              }
            }
            
            if (foundNode && foundNode.type === "FRAME") {
              startingPoints.push({
                id: foundNode.id,
                name: foundNode.name || "Flow from URL",
                path: [foundPage.name || "Page", foundNode.name || foundNode.id],
                isExplicit: false, // Не явно помечен как prototypeStartingPoint
                fromUrl: true, // Но добавлен из URL
                hasReactions: false,
                hasReactionsInChildren: false
              });
              console.log("Added flow from URL (not in prototypeStartingPoint):", foundNode.name, foundNode.id);
            } else {
              console.warn("Node from URL not found or is not a FRAME:", urlFlowId);
            }
          }
        } else {
          // Отмечаем существующий flow как fromUrl
          const existingFlow = startingPoints.find(sp => sp.id === urlFlowId);
          if (existingFlow) {
            existingFlow.fromUrl = true;
            console.log("Marked existing flow as fromUrl:", existingFlow.name, existingFlow.id);
          }
        }
      }
      
      console.log("findStartingPoints: Total frames:", totalFrames, "Frames with reactions:", framesWithReactions, "Found starting points:", startingPoints.length);
      
      // Сортируем: сначала flow из URL, потом остальные по имени
      startingPoints.sort((a, b) => {
        // Приоритет: fromUrl > остальные по имени
        if (a.fromUrl && !b.fromUrl) return -1;
        if (!a.fromUrl && b.fromUrl) return 1;
        return a.name.localeCompare(b.name);
      });
      
      console.log("Found starting points:", startingPoints.length, startingPoints);
      
      return startingPoints;
    }
    
    // Импорт прототипа по Share ссылке
    async function importFromShareLink() {
      console.log("importFromShareLink called");
      const shareLink = document.getElementById("shareLink").value.trim();
      console.log("shareLink:", shareLink);
      
      if (!shareLink) {
        showImportStatus("⚠️ Введите Share ссылку", "error");
        return;
      }
      
      // Парсим ссылку
      const parsed = parseFigmaShareLink(shareLink);
      if (!parsed || !parsed.fileKey) {
        showImportStatus("❌ Неверный формат Share ссылки. Поддерживаются форматы:\n- https://www.figma.com/design/...\n- https://www.figma.com/proto/...\n- https://www.figma.com/file/...", "error");
        return;
      }
      
      // Валидация fileKey (должен быть не пустым и содержать только допустимые символы)
      if (!parsed.fileKey || parsed.fileKey.length < 10) {
        showImportStatus("❌ Неверный формат file key в ссылке", "error");
        return;
      }
      
      // Проверяем наличие Figma Personal Access Token
      if (!FIGMA_ACCESS_TOKEN || FIGMA_ACCESS_TOKEN.trim().length === 0) {
        showImportStatus("⚠️ Требуется Figma Personal Access Token. Добавьте его в настройках (⚙️).", "error");
        showSettingsForm();
        // Фокусируемся на поле для токена
        setTimeout(() => {
          const tokenInput = document.getElementById("figmaToken");
          if (tokenInput) {
            tokenInput.focus();
            tokenInput.scrollIntoView({ behavior: "smooth", block: "center" });
          }
        }, 100);
        return;
      }
      
      // Валидация формата токена (должен начинаться с figd_)
      if (!FIGMA_ACCESS_TOKEN.startsWith("figd_")) {
        showImportStatus("⚠️ Неверный формат Figma Personal Access Token. Токен должен начинаться с 'figd_'.", "error");
        showSettingsForm();
        return;
      }
      
      showImportStatus("Загрузка данных из Figma REST API...", "loading");
      
      try {
        // СНАЧАЛА получаем starting points через Plugin API (как делает конкурент)
        console.log("Requesting starting points via Plugin API...");
        const pluginStartingPoints = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error("Timeout waiting for starting points"));
          }, 5000);
          
          const messageHandler = (event) => {
            if (event.data.pluginMessage) {
              const msg = event.data.pluginMessage;
              if (msg.type === "STARTING_POINTS") {
                clearTimeout(timeout);
                window.removeEventListener("message", messageHandler);
                resolve(msg.data);
              } else if (msg.type === "STARTING_POINTS_ERROR") {
                clearTimeout(timeout);
                window.removeEventListener("message", messageHandler);
                reject(new Error(msg.error));
              }
            }
          };
          
          window.addEventListener("message", messageHandler);
          parent.postMessage({ pluginMessage: { type: "GET_STARTING_POINTS" } }, "*");
        });
        
        console.log("Received starting points from Plugin API:", pluginStartingPoints);
        
        // Преобразуем flows из Plugin API в наш формат
        let flows = pluginStartingPoints.map(flow => {
          const isFromUrl = parsed.nodeId && flow.nodeId.replace(/:/g, '-') === parsed.nodeId;
          return {
            id: flow.nodeId,
            name: flow.name,
            path: [flow.name], // Упрощенный path, так как Plugin API не дает полный путь
            isExplicit: true,
            fromUrl: isFromUrl,
            hasReactions: false,
            hasReactionsInChildren: false
          };
        });
        
        // FALLBACK: Если flows не найдены через Plugin API, но есть nodeId в URL, добавляем его
        if (flows.length === 0 && parsed.nodeId) {
          console.log("No flows found via Plugin API, trying to add flow from URL nodeId:", parsed.nodeId);
          
          // Получаем данные файла через REST API для поиска фрейма по nodeId
          const fileData = await getFileDataFromREST(parsed.fileKey, FIGMA_ACCESS_TOKEN);
          currentFileData = fileData;
          currentFileKey = parsed.fileKey; // НОВОЕ: Сохраняем fileKey для передачи в generateFromRESTAPI
          
          // Нормализуем nodeId из URL (формат "143-552" -> "143:552")
          const normalizedNodeId = parsed.nodeId.replace(/-/g, ':');
          
          // Вспомогательная функция для поиска узла по ID в REST API данных
          function findNodeById(node, targetId) {
            if (!node) return null;
            if (node.id === targetId) return node;
            if (node.children) {
              for (const child of node.children) {
                const found = findNodeById(child, targetId);
                if (found) return found;
              }
            }
            return null;
          }
          
          // Ищем фрейм по nodeId в документе
          let foundNode = null;
          let foundPage = null;
          
          if (fileData.document && fileData.document.children) {
            for (const page of fileData.document.children) {
              if (page.id === normalizedNodeId) {
                // Если nodeId указывает на страницу, ищем первый фрейм на этой странице
                if (page.children) {
                  for (const child of page.children) {
                    if (child.type === "FRAME") {
                      foundNode = child;
                      foundPage = page;
                      break;
                    }
                  }
                }
                break;
              }
              
              foundNode = findNodeById(page, normalizedNodeId);
              if (foundNode) {
                foundPage = page;
                
                if (foundNode.type === "FRAME") {
                  break;
                } else {
                  // Если это не фрейм, ищем первый фрейм-потомок
                  function findFirstFrame(node) {
                    if (node.type === "FRAME") return node;
                    if (node.children) {
                      for (const child of node.children) {
                        const frame = findFirstFrame(child);
                        if (frame) return frame;
                      }
                    }
                    return null;
                  }
                  const firstFrame = findFirstFrame(foundNode);
                  if (firstFrame) {
                    foundNode = firstFrame;
                    break;
                  } else {
                    foundNode = null;
                  }
                }
              }
            }
          }
          
          if (foundNode && foundNode.type === "FRAME") {
            flows = [{
              id: foundNode.id,
              name: foundNode.name || "Flow from URL",
              path: [foundPage.name || "Page", foundNode.name || foundNode.id],
              isExplicit: false, // Не явно помечен как prototypeStartingPoint
              fromUrl: true, // Но добавлен из URL
              hasReactions: false,
              hasReactionsInChildren: false
            }];
            console.log("✓ Added flow from URL as fallback:", foundNode.name, foundNode.id);
          } else {
            console.warn("Could not find frame from URL nodeId:", normalizedNodeId);
          }
        } else {
          // Если flows найдены, все равно получаем данные файла для генерации прототипа
          const fileData = await getFileDataFromREST(parsed.fileKey, FIGMA_ACCESS_TOKEN);
          currentFileData = fileData;
          currentFileKey = parsed.fileKey; // НОВОЕ: Сохраняем fileKey для передачи в generateFromRESTAPI
        }
        
        availableFlows = flows;
        
        if (flows.length === 0) {
          showImportStatus("⚠️ Starting points не найдены в файле.", "error");
          return;
        }
        
        // Показываем выбор flows
        const flowsSelect = document.getElementById("flowsSelect");
        const flowsRadioContainer = document.getElementById("flowsRadioContainer");
        const useSelectedFlowBtn = document.getElementById("useSelectedFlow");
        
        if (!flowsSelect) {
          console.error("flowsSelect element not found!");
          showImportStatus("❌ Ошибка: элемент flowsSelect не найден", "error");
          return;
        }
        
        // Очищаем контейнеры
        flowsSelect.innerHTML = '<option value="">Выберите flow...</option>';
        if (flowsRadioContainer) {
          flowsRadioContainer.innerHTML = "";
        }
        
        // ВАЖНО: Всегда показываем выбор flows через выпадающий список (select)
        flowsSelect.style.display = "block";
        if (flowsRadioContainer) {
          flowsRadioContainer.style.display = "none";
        }
        
        // Находим flow из URL для предвыбора
        const urlFlowIndex = flows.findIndex(f => f.fromUrl);
        let defaultFlowId = null;
        
        flows.forEach((flow, index) => {
          const option = document.createElement("option");
          option.value = flow.id;
          let marker = "";
          if (flow.fromUrl) {
            marker = "🔗 "; // Маркер для starting point из URL
            defaultFlowId = flow.id;
          } else if (flow.isExplicit) {
            marker = "⭐ "; // Маркер для явно помеченного starting point
          }
          option.textContent = `${marker}${flow.name} (${flow.path.join(' → ')})`;
          flowsSelect.appendChild(option);
        });
        
        // Предвыбираем flow из URL, если он есть, иначе первый
        if (defaultFlowId) {
          flowsSelect.value = defaultFlowId;
        } else if (flows.length > 0) {
          flowsSelect.value = flows[0].id;
        }
        
        const flowsContainer = document.getElementById("flowsContainer");
        if (!flowsContainer) {
          console.error("flowsContainer element not found!");
          showImportStatus("❌ Ошибка: элемент flowsContainer не найден", "error");
          return;
        }
        
        console.log("Showing flowsContainer, flows count:", flows.length);
        // Просто показываем через display
        flowsContainer.style.display = 'block';
        const explicitCount = flows.filter(f => f.isExplicit || f.fromUrl).length;
        const fromUrlCount = flows.filter(f => f.fromUrl).length;
        let statusMsg = `✓ Найдено ${flows.length} flow(s)`;
        if (fromUrlCount > 0) {
          statusMsg += `, ${fromUrlCount} из URL`;
        }
        if (explicitCount > 0 && fromUrlCount === 0) {
          statusMsg += `, ${explicitCount} явно помеченных`;
        }
        statusMsg += `. Выберите нужный.`;
        showImportStatus(statusMsg, "success");
        
      } catch (error) {
        console.error("Error importing from share link:", error);
        
        // Более детальная обработка ошибок
        let errorMessage = "Ошибка при импорте";
        if (error.message.includes("401") || error.message.includes("403")) {
          errorMessage = "❌ Ошибка авторизации. Проверьте правильность Figma Personal Access Token в настройках.";
        } else if (error.message.includes("404")) {
          errorMessage = "❌ Файл не найден. Проверьте правильность Share ссылки и доступ к файлу.";
        } else if (error.message.includes("429")) {
          errorMessage = "❌ Превышен лимит запросов к Figma API. Подождите немного и попробуйте снова.";
        } else {
          errorMessage = `❌ Ошибка: ${error.message}`;
        }
        
        showImportStatus(errorMessage, "error");
      }
    }
    
    // Использование выбранного flow
    async function useSelectedFlow(flowId = null) {
      let selectedFlowId = flowId;
      
      // Если flowId не передан, получаем из select
      if (!selectedFlowId) {
        const flowsSelect = document.getElementById("flowsSelect");
        if (flowsSelect) {
          selectedFlowId = flowsSelect.value;
        }
      }
      
      if (!selectedFlowId) {
        showImportStatus("⚠️ Выберите flow", "error");
        return;
      }
      
      if (!currentFileData) {
        showImportStatus("❌ Данные файла не загружены", "error");
        return;
      }
      
      showImportStatus("Генерация прототипа из выбранного flow...", "loading");
      
      // Сохраняем выбранный flow ID
      currentSelectedFlowId = selectedFlowId;
      
      // Отправляем сообщение в code.js для генерации прототипа из REST API данных
      parent.postMessage({
        pluginMessage: {
          type: "GENERATE_FROM_REST_API",
          fileData: currentFileData,
          selectedFlowId: selectedFlowId,
          fileKey: currentFileKey // НОВОЕ: Передаем fileKey для figmaFileId
        }
      }, "*");
    }
    
    // Обработчики для attach to study
    const attachToStudyToggleEl = document.getElementById("attachToStudyToggle");
    if (attachToStudyToggleEl) {
      attachToStudyToggleEl.addEventListener("change", function(e) {
        const studySelectContainer = document.getElementById("studySelectContainer");
        if (e.target.checked) {
          studySelectContainer.style.display = "block";
          loadStudies();
        } else {
          studySelectContainer.style.display = "none";
          // Очищаем ошибки прикрепления
          const attachErrorEl = document.getElementById("attachError");
          const attachRetryContainer = document.getElementById("attachRetryContainer");
          if (attachErrorEl) attachErrorEl.style.display = "none";
          if (attachRetryContainer) attachRetryContainer.style.display = "none";
        }
      });
    }
    
    const refreshStudiesBtn = document.getElementById("refreshStudiesBtn");
    if (refreshStudiesBtn) {
      refreshStudiesBtn.addEventListener("click", function(e) {
        e.preventDefault();
        loadStudies();
      });
    }
    
    const retryAttachBtn = document.getElementById("retryAttachBtn");
    if (retryAttachBtn) {
      retryAttachBtn.addEventListener("click", async function(e) {
        e.preventDefault();
        if (!lastCreatedPrototypeId) {
          showStatus("❌ Нет созданного прототипа для прикрепления", "error");
          return;
        }
        
        const attachToStudyToggle = document.getElementById("attachToStudyToggle");
        const studySelect = document.getElementById("studySelect");
        const attachErrorEl = document.getElementById("attachError");
        const attachRetryContainer = document.getElementById("attachRetryContainer");
        
        if (!attachToStudyToggle || !attachToStudyToggle.checked || !studySelect || !studySelect.value) {
          showStatus("⚠️ Выберите Study для прикрепления", "error");
          return;
        }
        
        const taskDescription = document.getElementById("taskDescription").value.trim();
        
        if (attachErrorEl) attachErrorEl.style.display = "none";
        if (attachRetryContainer) attachRetryContainer.style.display = "none";
        showStatus("Повторная попытка прикрепления к Study...", "loading");
        
        try {
          await attachToStudy(lastCreatedPrototypeId, studySelect.value, taskDescription);
          if (attachErrorEl) attachErrorEl.style.display = "none";
          if (attachRetryContainer) attachRetryContainer.style.display = "none";
          showStatus("✓ Прототип успешно прикреплен к Study!", "success");
        } catch (error) {
          console.error("Error retrying attach:", error);
          if (attachErrorEl) {
            attachErrorEl.textContent = `⚠️ Ошибка прикрепления: ${error.message}`;
            attachErrorEl.style.display = "block";
          }
          if (attachRetryContainer) attachRetryContainer.style.display = "block";
          showStatus("❌ Не удалось прикрепить к Study", "error");
        }
      });
    }
    
    // Обработчики
    document.getElementById("importFromLink").addEventListener("click", function(e) {
      e.preventDefault();
      importFromShareLink();
    });
    
    document.getElementById("useSelectedFlow").addEventListener("click", function(e) {
      e.preventDefault();
      useSelectedFlow();
    });

    // Инициализация при загрузке (если конфигурация уже есть в fallback)
    setTimeout(() => {
      if (!configLoaded) {
        initUI();
      }
    }, 100);
  </script>
</body>
</html>
